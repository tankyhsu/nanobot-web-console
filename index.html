<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>nanobot Console</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
:root {
  /* Dark theme (default) */
  --bg-body: #1a1a2e;
  --bg-sidebar: #16213e;
  --bg-toolbar: #16213e;
  --bg-input: #1a1a40;
  --bg-hover: #1a1a40;
  --bg-active: #0f3460;
  --bg-user-bubble: #0f3460;
  --bg-bot-bubble: #2d2d4e;
  --border: #0f3460;
  --text: #e0e0e0;
  --text-dim: #888;
  --accent: #e94560;
  --link: #64b5f6;
  --ev-think-bg: #33300a; --ev-think-fg: #ffd54f;
  --ev-tool-bg: #0a1929; --ev-tool-fg: #64b5f6;
  --ev-result-bg: #0a2910; --ev-result-fg: #81c784;
  --code-bg: #0d1117;
  --code-border: #30363d;
  --pre-bg: #161b22;
}
.light {
  --bg-body: #f5f5f5;
  --bg-sidebar: #ffffff;
  --bg-toolbar: #ffffff;
  --bg-input: #ffffff;
  --bg-hover: #f0f0f0;
  --bg-active: #e3f2fd;
  --bg-user-bubble: #1976d2;
  --bg-bot-bubble: #ffffff;
  --border: #e0e0e0;
  --text: #212121;
  --text-dim: #757575;
  --accent: #e91e63;
  --link: #1565c0;
  --ev-think-bg: #fff8e1; --ev-think-fg: #f57f17;
  --ev-tool-bg: #e3f2fd; --ev-tool-fg: #1565c0;
  --ev-result-bg: #e8f5e9; --ev-result-fg: #2e7d32;
  --code-bg: #f6f8fa;
  --code-border: #d0d7de;
  --pre-bg: #f6f8fa;
}
.light .msg.user .bubble { color: #fff; }
.light .msg.assistant .bubble { border: 1px solid var(--border); color: #333; }

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text); height: 100vh; display: flex; transition: background 0.3s, color 0.3s; }
a { color: var(--link); text-decoration: none; }

.sidebar { width: 280px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
.sidebar-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.sidebar-header h1 { font-size: 18px; color: var(--accent); }
.sidebar-header .controls { display: flex; gap: 8px; align-items: center; }
.theme-btn { background: none; border: 1px solid var(--border); color: var(--text); border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 14px; }
.theme-btn:hover { background: var(--bg-hover); }
.status-bar { padding: 8px 16px; font-size: 12px; color: var(--text-dim); border-bottom: 1px solid var(--border); }
.status-bar.online { color: #4caf50; }
.session-list { flex: 1; overflow-y: auto; }
.session-item { padding: 10px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 8px; }
.session-item:hover { background: var(--bg-hover); }
.session-item.active { background: var(--bg-active); border-left: 3px solid var(--accent); }
.session-info { flex: 1; min-width: 0; }
.session-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.session-meta { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
.session-channel { display: inline-block; padding: 1px 5px; border-radius: 3px; font-size: 10px; font-weight: 600; margin-right: 4px; }
.ch-feishu { background: #1b5e20; color: #a5d6a7; }
.ch-api { background: #1a237e; color: #9fa8da; }
.ch-ws { background: #4a148c; color: #ce93d8; }
.ch-cli { background: #3e2723; color: #bcaaa4; }
.light .ch-feishu { background: #c8e6c9; color: #1b5e20; }
.light .ch-api { background: #c5cae9; color: #1a237e; }
.light .ch-ws { background: #e1bee7; color: #4a148c; }
.light .ch-cli { background: #d7ccc8; color: #3e2723; }
.del-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 16px; padding: 2px 6px; border-radius: 3px; opacity: 0; transition: opacity 0.2s; flex-shrink: 0; }
.session-item:hover .del-btn { opacity: 1; }
.del-btn:hover { color: #f44336; background: rgba(244,67,54,0.1); }

.main { flex: 1; display: flex; flex-direction: column; }
.toolbar { padding: 10px 20px; background: var(--bg-toolbar); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
.toolbar .title { font-size: 15px; flex: 1; }
.toolbar button { padding: 5px 12px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text); border-radius: 4px; cursor: pointer; font-size: 13px; }
.toolbar button:hover { background: var(--bg-active); }
.toolbar button.active { background: var(--accent); border-color: var(--accent); color: #fff; }

.tab-row { display: flex; gap: 0; padding: 6px 16px; border-bottom: 1px solid var(--border); }
.tab { padding: 6px 12px; cursor: pointer; border-bottom: 2px solid transparent; font-size: 12px; color: var(--text-dim); }
.tab.active { border-bottom-color: var(--accent); color: var(--accent); }
.tab:hover { color: var(--accent); }

.chat-area { flex: 1; overflow-y: auto; padding: 20px; }
.msg { margin-bottom: 16px; max-width: 85%; }
.msg.user { margin-left: auto; }
.msg.assistant { margin-right: auto; }
.msg .bubble { padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.7; word-break: break-word; }
.msg.user .bubble { background: var(--bg-user-bubble); border-bottom-right-radius: 4px; }
.msg.assistant .bubble { background: var(--bg-bot-bubble); border-bottom-left-radius: 4px; }
.msg .time { font-size: 11px; color: var(--text-dim); margin-top: 4px; padding: 0 4px; }
.msg.user .time { text-align: right; }

/* Markdown inside bubbles */
.bubble h1,.bubble h2,.bubble h3 { margin: 8px 0 4px; }
.bubble h1 { font-size: 1.3em; } .bubble h2 { font-size: 1.15em; } .bubble h3 { font-size: 1.05em; }
.bubble p { margin: 4px 0; }
.bubble ul, .bubble ol { margin: 4px 0 4px 20px; }
.bubble li { margin: 2px 0; }
.bubble code { background: var(--code-bg); padding: 1px 5px; border-radius: 3px; font-size: 0.9em; border: 1px solid var(--code-border); }
.bubble pre { background: var(--pre-bg); padding: 10px; border-radius: 6px; overflow-x: auto; margin: 8px 0; border: 1px solid var(--code-border); }
.bubble pre code { background: none; border: none; padding: 0; }
.bubble blockquote { border-left: 3px solid var(--accent); padding-left: 10px; margin: 6px 0; color: var(--text-dim); }
.bubble table { border-collapse: collapse; margin: 6px 0; width: 100%; }
.bubble th, .bubble td { border: 1px solid var(--border); padding: 4px 8px; font-size: 13px; }
.bubble th { background: var(--bg-hover); }

.stream-event { padding: 4px 10px; margin: 2px 0; font-size: 12px; border-radius: 4px; font-family: monospace; max-width: 90%; word-break: break-all; }
.ev-thinking { color: var(--ev-think-fg); background: var(--ev-think-bg); }
.ev-tool_call { color: var(--ev-tool-fg); background: var(--ev-tool-bg); }
.ev-tool_result { color: var(--ev-result-fg); background: var(--ev-result-bg); }

/* Enhanced tool event styles */
.tool-event { margin: 6px 0; max-width: 90%; border-radius: 6px; overflow: hidden; font-size: 12px; }
.tool-event-header { display: flex; align-items: center; gap: 6px; padding: 6px 10px; cursor: pointer; user-select: none; }
.tool-event-header .tool-icon { font-size: 14px; flex-shrink: 0; }
.tool-event-header .tool-name { font-weight: 600; }
.tool-event-header .tool-toggle { margin-left: auto; font-size: 10px; opacity: 0.6; transition: transform 0.2s; }
.tool-event-header .tool-toggle.open { transform: rotate(90deg); }
.tool-event-body { padding: 0 10px 8px 30px; font-family: monospace; font-size: 11px; line-height: 1.6; white-space: pre-wrap; word-break: break-all; display: none; }
.tool-event-body.open { display: block; }
.tool-call-event { background: var(--ev-tool-bg); color: var(--ev-tool-fg); }
.tool-result-event { background: var(--ev-result-bg); color: var(--ev-result-fg); }
.tool-result-event.tool-error { background: rgba(183,28,28,0.15); color: #ef9a9a; }
.light .tool-result-event.tool-error { background: #ffebee; color: #c62828; }
.tool-args-table .arg-row { display: flex; gap: 6px; padding: 1px 0; }
.tool-args-table .arg-key { opacity: 0.7; min-width: 60px; flex-shrink: 0; }
.tool-args-table .arg-val { flex: 1; }
.tool-result-summary { opacity: 0.7; font-size: 11px; margin-left: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.input-area { padding: 12px 20px; background: var(--bg-toolbar); border-top: 1px solid var(--border); display: flex; gap: 8px; }
.input-area input { flex: 1; padding: 10px 14px; background: var(--bg-input); border: 1px solid var(--border); color: var(--text); border-radius: 6px; font-size: 14px; outline: none; }
.input-area input:focus { border-color: var(--accent); }
.input-area button { padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
.input-area button:disabled { opacity: 0.5; }

.empty { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-dim); font-size: 16px; }

.confirm-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 999; }
.confirm-box { background: var(--bg-sidebar); border: 1px solid var(--border); border-radius: 8px; padding: 24px; min-width: 320px; }
.confirm-box h3 { margin-bottom: 12px; }
.confirm-box p { color: var(--text-dim); margin-bottom: 16px; font-size: 14px; }
.confirm-box .btns { display: flex; gap: 8px; justify-content: flex-end; }
.confirm-box button { padding: 6px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; border: 1px solid var(--border); }
.confirm-box .btn-cancel { background: var(--bg-input); color: var(--text); }
.confirm-box .btn-danger { background: #f44336; color: #fff; border-color: #f44336; }

/* Viking knowledge base styles */
.viking-panel { display: flex; flex-direction: column; height: 100%; }
.viking-search { padding: 12px; border-bottom: 1px solid var(--border); display: flex; gap: 8px; }
.viking-search input { flex: 1; padding: 8px 12px; background: var(--bg-input); border: 1px solid var(--border); color: var(--text); border-radius: 6px; font-size: 13px; outline: none; }
.viking-search input:focus { border-color: var(--accent); }
.viking-search button { padding: 8px 14px; background: var(--accent); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
.viking-breadcrumb { padding: 8px 12px; font-size: 12px; color: var(--text-dim); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
.viking-breadcrumb a { color: var(--link); cursor: pointer; }
.viking-breadcrumb a:hover { text-decoration: underline; }
.viking-content { flex: 1; overflow-y: auto; padding: 12px; }
.viking-item { padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; }
.viking-item:hover { background: var(--bg-hover); }
.viking-item .vi-name { font-size: 14px; font-weight: 500; }
.viking-item .vi-meta { font-size: 11px; color: var(--text-dim); margin-top: 4px; }
.viking-item .vi-icon { margin-right: 6px; }
.viking-result { padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; }
.viking-result .vr-type { font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px; }
.vr-memory { background: #4a148c; color: #ce93d8; }
.vr-resource { background: #1a237e; color: #9fa8da; }
.light .vr-memory { background: #e1bee7; color: #4a148c; }
.light .vr-resource { background: #c5cae9; color: #1a237e; }
.viking-result .vr-content { font-size: 13px; line-height: 1.6; word-break: break-word; }
.viking-detail { padding: 16px; }
.viking-detail h3 { margin-bottom: 8px; font-size: 16px; }
.viking-detail .vd-meta { font-size: 12px; color: var(--text-dim); margin-bottom: 12px; }
.viking-detail .vd-body { font-size: 14px; line-height: 1.7; white-space: pre-wrap; word-break: break-word; }
.viking-status { font-size: 11px; padding: 4px 8px; border-radius: 3px; }
.vs-on { background: #1b5e20; color: #a5d6a7; }
.vs-off { background: #b71c1c; color: #ef9a9a; }
.light .vs-on { background: #c8e6c9; color: #1b5e20; }
.light .vs-off { background: #ffcdd2; color: #b71c1c; }
.viking-sessions-list { padding: 12px; }
.viking-sessions-list .vs-item { padding: 8px; border-bottom: 1px solid var(--border); font-size: 13px; }
.viking-empty { text-align: center; color: var(--text-dim); padding: 40px 20px; font-size: 14px; }
.viking-back-btn { background: none; border: 1px solid var(--border); color: var(--text); border-radius: 4px; padding: 4px 10px; cursor: pointer; font-size: 12px; margin-right: 8px; }
.viking-back-btn:hover { background: var(--bg-hover); }

/* Settings panel */
.settings-panel { padding: 16px 20px; overflow-y: auto; height: 100%; }
.settings-section { margin-bottom: 24px; }
.settings-section h3 { font-size: 14px; color: var(--accent); margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 6px; }
.settings-grid { display: grid; grid-template-columns: 120px 1fr; gap: 8px 12px; align-items: center; font-size: 13px; }
.settings-grid label { color: var(--text-dim); text-align: right; }
.settings-grid input, .settings-grid select { padding: 6px 10px; background: var(--bg-input); border: 1px solid var(--border); color: var(--text); border-radius: 4px; font-size: 13px; outline: none; }
.settings-grid input:focus, .settings-grid select:focus { border-color: var(--accent); }
.settings-save { margin-top: 8px; padding: 6px 16px; background: var(--accent); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
.settings-save:hover { opacity: 0.9; }
.settings-save:disabled { opacity: 0.5; cursor: default; }
.settings-msg { font-size: 12px; margin-top: 6px; }
.settings-msg.ok { color: #4caf50; }
.settings-msg.err { color: #f44336; }
.tool-card { padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; }
.tool-card .tc-name { font-weight: 600; font-size: 13px; }
.tool-card .tc-desc { font-size: 12px; color: var(--text-dim); margin-top: 4px; }
.tool-card .tc-params { font-size: 11px; color: var(--text-dim); margin-top: 4px; font-family: monospace; }
.skill-card { padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; }
.skill-card:hover { background: var(--bg-hover); }
.skill-card .sk-name { font-weight: 600; font-size: 13px; }
.skill-card .sk-desc { font-size: 12px; color: var(--text-dim); margin-top: 4px; }
.skill-detail { padding: 12px; font-size: 13px; line-height: 1.7; }
.skill-detail pre { background: var(--pre-bg); padding: 8px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
.prompt-editor { width: 100%; min-height: 200px; padding: 10px; background: var(--bg-input); border: 1px solid var(--border); color: var(--text); border-radius: 6px; font-family: monospace; font-size: 12px; line-height: 1.6; resize: vertical; outline: none; }
.prompt-editor:focus { border-color: var(--accent); }
.prompt-tabs { display: flex; gap: 0; margin-bottom: 8px; }
.prompt-tab { padding: 6px 12px; cursor: pointer; border-bottom: 2px solid transparent; font-size: 12px; color: var(--text-dim); }
.prompt-tab.active { border-bottom-color: var(--accent); color: var(--accent); }
.prompt-tab:hover { color: var(--accent); }

/* Hamburger button - hidden on desktop */
.menu-btn { display: none; background: none; border: 1px solid var(--border); color: var(--text); border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 18px; line-height: 1; }
.sidebar-overlay { display: none; }

/* Mobile responsive */
@media (max-width: 768px) {
  .sidebar { position: fixed; left: -300px; top: 0; bottom: 0; width: 280px; z-index: 100; transition: left 0.3s ease; box-shadow: none; }
  .sidebar.open { left: 0; box-shadow: 4px 0 20px rgba(0,0,0,0.3); }
  .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 99; }
  .sidebar-overlay.open { display: block; }
  .menu-btn { display: block; }
  .main { width: 100%; }
  .toolbar { padding: 8px 12px; }
  .toolbar .title { font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .chat-area { padding: 12px; }
  .msg { max-width: 92%; }
  .msg .bubble { font-size: 15px; padding: 10px 12px; }
  .stream-event { max-width: 100%; font-size: 11px; }
  .tool-event { max-width: 100%; }
  .tool-event-body { font-size: 10px; padding-left: 24px; }
  .input-area { padding: 8px 12px; gap: 6px; }
  .input-area input { padding: 10px 12px; font-size: 16px; /* prevent iOS zoom */ }
  .input-area button { padding: 10px 16px; font-size: 14px; }
  .del-btn { opacity: 0.6; } /* always visible on touch */
  .confirm-box { min-width: auto; margin: 0 16px; width: calc(100% - 32px); max-width: 360px; }
  .bubble pre { font-size: 12px; }
  .bubble table { font-size: 12px; display: block; overflow-x: auto; }
}
</style>
</head>
<body>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h1>nanobot</h1>
    <div class="controls">
      <button class="theme-btn" onclick="toggleLang()" id="langBtn" title="Language">EN</button>
      <button class="theme-btn" onclick="toggleTheme()" id="themeBtn" title="Toggle theme">ðŸŒ™</button>
    </div>
  </div>
  <div class="status-bar" id="status"><span data-i18n="connecting">Connecting...</span> <span id="vikingStatus"></span></div>
  <div class="tab-row">
    <div class="tab active" onclick="filterSessions('all', this)" data-i18n="all">All</div>
    <div class="tab" onclick="filterSessions('feishu', this)">Feishu</div>
    <div class="tab" onclick="filterSessions('api', this)">API</div>
    <div class="tab" onclick="filterSessions('ws', this)">WS</div>
  </div>
  <div class="session-list" id="sessionList"></div>
</div>
<div class="main">
  <div class="toolbar">
    <button class="menu-btn" onclick="toggleSidebar()" title="Menu">&#9776;</button>
    <div class="title" id="chatTitle" data-i18n="selectSession">Select a session</div>
    <button onclick="openViking()" id="vikingBtn" data-i18n="knowledge">Knowledge</button>
    <button onclick="openLiveChat()" id="liveChatBtn" data-i18n="liveChat">Live Chat</button>
    <button onclick="openSettings()" id="settingsBtn" data-i18n="settings">Settings</button>
  </div>
  <div class="chat-area" id="chatArea">
    <div class="empty" data-i18n="emptyHint">Select a session or start a Live Chat</div>
  </div>
  <div class="input-area" id="inputArea" style="display:none;">
    <input type="text" id="msgInput" placeholder="Type a message..." data-i18n="typeMessage" onkeydown="if(event.key==='Enter'&&!event.isComposing&&event.keyCode!==229)sendMsg()">
    <button onclick="sendMsg()" id="sendBtn" data-i18n="send">Send</button>
  </div>
</div>

<!-- Delete confirm dialog -->
<div class="confirm-overlay" id="confirmOverlay" style="display:none;" onclick="if(event.target===this)closeConfirm()">
  <div class="confirm-box">
    <h3 data-i18n="deleteSession">Delete Session</h3>
    <p id="confirmText">Are you sure?</p>
    <div class="btns">
      <button class="btn-cancel" onclick="closeConfirm()" data-i18n="cancel">Cancel</button>
      <button class="btn-danger" onclick="confirmDelete()" data-i18n="delete">Delete</button>
    </div>
  </div>
</div>

<script>
// --- i18n ---
const I18N = {
  en: {
    connecting: 'Connecting...',
    agentOnline: 'Agent Online',
    agentLoading: 'Agent Loading...',
    offline: 'Offline',
    vikingOn: 'Viking ON',
    vikingOff: 'Viking OFF',
    all: 'All',
    messages: 'messages',
    selectSession: 'Select a session',
    knowledge: 'Knowledge',
    liveChat: 'Live Chat',
    settings: 'Settings',
    emptyHint: 'Select a session or start a Live Chat',
    typeMessage: 'Type a message...',
    send: 'Send',
    deleteSession: 'Delete Session',
    deleteConfirm: 'Delete session "{name}"? This cannot be undone.',
    cancel: 'Cancel',
    delete: 'Delete',
    sessionDeleted: 'Session deleted',
    searchKB: 'Search knowledge base...',
    search: 'Search',
    loading: 'Loading...',
    emptyDir: 'Empty directory',
    noItems: 'No visible items',
    searching: 'Searching...',
    noResults: 'No results for "{query}"',
    noResultsGeneric: 'No results',
    vikingUnavailable: 'Viking is not available',
    directory: 'Directory',
    back: 'Back',
    resources: 'resources',
    modelConfig: 'Model Configuration',
    model: 'Model',
    provider: 'Provider',
    temperature: 'Temperature',
    maxTokens: 'Max Tokens',
    maxIterations: 'Max Iterations',
    saveConfig: 'Save Config',
    savePrompt: 'Save Prompt',
    tools: 'Tools',
    skills: 'Skills',
    systemPrompts: 'System Prompts',
    memory: 'Memory',
    noSkills: 'No skills configured',
    noChanges: 'No changes',
    loadingConfig: 'Loading configuration...',
    failedLoadConfig: 'Failed to load config: ',
    restartToApply: 'Restart service to apply.',
    saved: 'Saved: ',
    error: 'Error: ',
    connected: 'Connected',
    disconnected: 'Disconnected',
    thinking: 'Thinking... (iteration {n})',
    empty: 'empty',
    charsTotal: 'chars total',
    reconnecting: 'Reconnecting...',
  },
  zh: {
    connecting: 'è¿žæŽ¥ä¸­...',
    agentOnline: 'Agent åœ¨çº¿',
    agentLoading: 'Agent åŠ è½½ä¸­...',
    offline: 'ç¦»çº¿',
    vikingOn: 'Viking å·²å¼€å¯',
    vikingOff: 'Viking æœªå¼€å¯',
    all: 'å…¨éƒ¨',
    messages: 'æ¡æ¶ˆæ¯',
    selectSession: 'é€‰æ‹©ä¸€ä¸ªä¼šè¯',
    knowledge: 'çŸ¥è¯†åº“',
    liveChat: 'å®žæ—¶å¯¹è¯',
    settings: 'è®¾ç½®',
    emptyHint: 'é€‰æ‹©ä¸€ä¸ªä¼šè¯æˆ–å¼€å§‹å®žæ—¶å¯¹è¯',
    typeMessage: 'è¾“å…¥æ¶ˆæ¯...',
    send: 'å‘é€',
    deleteSession: 'åˆ é™¤ä¼šè¯',
    deleteConfirm: 'ç¡®å®šåˆ é™¤ä¼šè¯ "{name}"ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
    cancel: 'å–æ¶ˆ',
    delete: 'åˆ é™¤',
    sessionDeleted: 'ä¼šè¯å·²åˆ é™¤',
    searchKB: 'æœç´¢çŸ¥è¯†åº“...',
    search: 'æœç´¢',
    loading: 'åŠ è½½ä¸­...',
    emptyDir: 'ç©ºç›®å½•',
    noItems: 'æ²¡æœ‰å¯è§é¡¹ç›®',
    searching: 'æœç´¢ä¸­...',
    noResults: 'æœªæ‰¾åˆ° "{query}" çš„ç›¸å…³ç»“æžœ',
    noResultsGeneric: 'æ— ç»“æžœ',
    vikingUnavailable: 'Viking ä¸å¯ç”¨',
    directory: 'ç›®å½•',
    back: 'è¿”å›ž',
    resources: 'èµ„æº',
    modelConfig: 'æ¨¡åž‹é…ç½®',
    model: 'æ¨¡åž‹',
    provider: 'æœåŠ¡å•†',
    temperature: 'æ¸©åº¦',
    maxTokens: 'æœ€å¤§ Token',
    maxIterations: 'æœ€å¤§è¿­ä»£',
    saveConfig: 'ä¿å­˜é…ç½®',
    savePrompt: 'ä¿å­˜æç¤ºè¯',
    tools: 'å·¥å…·',
    skills: 'æŠ€èƒ½',
    systemPrompts: 'ç³»ç»Ÿæç¤ºè¯',
    memory: 'è®°å¿†',
    noSkills: 'æœªé…ç½®æŠ€èƒ½',
    noChanges: 'æ— å˜æ›´',
    loadingConfig: 'åŠ è½½é…ç½®ä¸­...',
    failedLoadConfig: 'åŠ è½½é…ç½®å¤±è´¥ï¼š',
    restartToApply: 'é‡å¯æœåŠ¡åŽç”Ÿæ•ˆã€‚',
    saved: 'å·²ä¿å­˜ï¼š',
    error: 'é”™è¯¯ï¼š',
    connected: 'å·²è¿žæŽ¥',
    disconnected: 'å·²æ–­å¼€',
    thinking: 'æ€è€ƒä¸­...ï¼ˆç¬¬ {n} è½®ï¼‰',
    empty: 'ç©º',
    charsTotal: 'å­—ç¬¦',
    reconnecting: 'é‡è¿žä¸­...',
  }
};

let currentLang = localStorage.getItem('lang') || 'en';

function t(key, params) {
  let s = (I18N[currentLang] && I18N[currentLang][key]) || I18N.en[key] || key;
  if (params) {
    Object.entries(params).forEach(([k, v]) => { s = s.replace('{' + k + '}', v); });
  }
  return s;
}

function getLangLocale() {
  return currentLang === 'zh' ? 'zh-CN' : 'en-US';
}

function toggleLang() {
  currentLang = currentLang === 'en' ? 'zh' : 'en';
  localStorage.setItem('lang', currentLang);
  document.getElementById('langBtn').textContent = currentLang === 'en' ? 'EN' : 'ä¸­';
  applyLang();
}

function applyLang() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    if (el.tagName === 'INPUT') el.placeholder = t(key);
    else el.textContent = t(key);
  });
  // Re-render dynamic content
  renderSessions();
  checkHealth();
  if (isSettingsMode) renderSettings();
  if (isVikingMode) renderVikingBrowser();
}

function initLang() {
  if (!localStorage.getItem('lang')) {
    currentLang = navigator.language.startsWith('zh') ? 'zh' : 'en';
  }
  document.getElementById('langBtn').textContent = currentLang === 'en' ? 'EN' : 'ä¸­';
  applyLang();
}

const API = location.origin;
const WS_URL = `ws://${location.host}/ws/chat`;
let sessions = [];
let currentFilter = 'all';
let currentSession = null;
let ws = null;
let wsReconnectTimer = null;
let wsReconnectDelay = 1000;
let isLiveChat = false;
let liveChatHtml = '';  // persisted live chat content
let deleteTarget = null;
let isComposing = false;

// --- Markdown ---
marked.setOptions({ breaks: true, gfm: true });
function renderMd(text) {
  try { return marked.parse(text || ''); }
  catch(e) { return escHtml(text); }
}
function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// --- Theme ---
function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
  document.getElementById('themeBtn').textContent = isLight ? 'ðŸŒž' : 'ðŸŒ™';
}
function initTheme() {
  const saved = localStorage.getItem('theme');
  if (saved === 'light') {
    document.body.classList.add('light');
    document.getElementById('themeBtn').textContent = 'ðŸŒž';
  }
}

// --- Health ---
async function checkHealth() {
  try {
    const r = await fetch(`${API}/health`);
    const d = await r.json();
    const el = document.getElementById('status');
    const vs = document.getElementById('vikingStatus');
    const agentOk = d.agent_ready;
    el.className = 'status-bar' + (agentOk ? ' online' : '');
    const agentText = agentOk ? t('agentOnline') : t('agentLoading');
    const vikingOk = d.viking_ready;
    el.innerHTML = agentText + ' ' + (vikingOk
      ? '<span class="viking-status vs-on">' + t('vikingOn') + '</span>'
      : '<span class="viking-status vs-off">' + t('vikingOff') + '</span>');
  } catch(e) {
    const el = document.getElementById('status');
    el.textContent = t('offline');
    el.className = 'status-bar';
  }
}

// --- Sessions ---
async function loadSessions() {
  try {
    const r = await fetch(`${API}/api/sessions`);
    sessions = await r.json();
    renderSessions();
  } catch(e) { console.error(e); }
}

function getChannel(name) {
  if (name.startsWith('feishu_')) return 'feishu';
  if (name.startsWith('api_')) return 'api';
  if (name.startsWith('ws_')) return 'ws';
  if (name.startsWith('cli_')) return 'cli';
  return 'other';
}

function renderSessions() {
  const list = document.getElementById('sessionList');
  const filtered = currentFilter === 'all' ? sessions : sessions.filter(s => getChannel(s.name) === currentFilter);
  list.innerHTML = filtered.map(s => {
    const ch = getChannel(s.name);
    const date = s.updated ? new Date(s.updated).toLocaleString(getLangLocale()) : '';
    const active = s.name === currentSession ? ' active' : '';
    return `<div class="session-item${active}" onclick="loadChat('${s.name}')" id="s_${s.name}">
      <div class="session-info">
        <div class="session-name"><span class="session-channel ch-${ch}">${ch}</span>${s.display || s.name}</div>
        <div class="session-meta">${s.messages} ${t('messages')} | ${date}</div>
      </div>
      <button class="del-btn" onclick="event.stopPropagation();askDelete('${s.name}')" title="Delete">&times;</button>
    </div>`;
  }).join('');
}

function filterSessions(filter, el) {
  currentFilter = filter;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderSessions();
}

// --- Delete ---
function askDelete(name) {
  deleteTarget = name;
  document.getElementById('confirmText').textContent = t('deleteConfirm', {name});
  document.getElementById('confirmOverlay').style.display = 'flex';
}
function closeConfirm() {
  document.getElementById('confirmOverlay').style.display = 'none';
  deleteTarget = null;
}
async function confirmDelete() {
  if (!deleteTarget) return;
  try {
    await fetch(`${API}/api/sessions/${deleteTarget}`, { method: 'DELETE' });
    if (currentSession === deleteTarget) {
      currentSession = null;
      document.getElementById('chatArea').innerHTML = '<div class="empty">' + t('sessionDeleted') + '</div>';
      document.getElementById('chatTitle').textContent = t('selectSession');
    }
    await loadSessions();
  } catch(e) { console.error(e); }
  closeConfirm();
}

// --- URL routing ---
function updateUrl(params) {
  const url = new URL(location.href);
  url.search = '';
  if (params) {
    Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
  }
  history.pushState(null, '', url);
}

function getUrlSession() {
  const params = new URLSearchParams(location.search);
  return params.get('session') || params.get('s') || null;
}

// --- Chat History ---
async function loadChat(name) {
  // Save live chat content if leaving live mode
  if (isLiveChat) {
    liveChatHtml = document.getElementById('chatArea').innerHTML;
  }
  isLiveChat = false;
  isVikingMode = false;
  currentSession = name;
  document.getElementById('inputArea').style.display = 'none';
  document.getElementById('liveChatBtn').classList.remove('active');
  document.getElementById('vikingBtn').classList.remove('active');
  updateUrl({ session: name });
  closeSidebar();
  renderSessions();
  try {
    const r = await fetch(`${API}/api/sessions/${name}`);
    const msgs = await r.json();
    const area = document.getElementById('chatArea');
    document.getElementById('chatTitle').textContent = name;
    area.innerHTML = msgs.map(m => {
      if (!m.role || m.role === '_type') return '';
      const time = m.timestamp ? new Date(m.timestamp).toLocaleString(getLangLocale()) : '';
      const timeDiv = `<div class="time" style="font-size:11px;color:var(--text-dim);padding:2px 4px 8px">${time}</div>`;

      // Tool result messages
      if (m.role === 'tool') {
        return buildToolResultHtml(m.name, m.content) + timeDiv;
      }

      // Assistant messages: may have tool_calls and/or content
      if (m.role === 'assistant') {
        let html = '';
        if (m.tool_calls && m.tool_calls.length > 0) {
          for (const tc of m.tool_calls) {
            const tcName = (tc.function && tc.function.name) || tc.name || 'tool';
            const tcArgs = (tc.function && tc.function.arguments) || JSON.stringify(tc.arguments || {});
            html += buildToolCallHtml(tcName, tcArgs);
          }
        }
        if (m.content && m.content.trim()) {
          html += `<div class="msg assistant"><div class="bubble">${renderMd(m.content)}</div><div class="time">${time}</div></div>`;
        } else if (html) {
          html += timeDiv;
        }
        return html;
      }

      // User and other messages
      return `<div class="msg ${m.role}">
        <div class="bubble">${escHtml(m.content || '')}</div>
        <div class="time">${time}</div>
      </div>`;
    }).join('');
    area.scrollTop = area.scrollHeight;
  } catch(e) { console.error(e); }
}

// --- Live Chat ---
function openLiveChat() {
  // Close viking mode if open
  if (isVikingMode) {
    isVikingMode = false;
    document.getElementById('vikingBtn').classList.remove('active');
  }
  isLiveChat = !isLiveChat;
  const btn = document.getElementById('liveChatBtn');
  const input = document.getElementById('inputArea');
  currentSession = null;
  renderSessions();
  if (isLiveChat) {
    btn.classList.add('active');
    input.style.display = 'flex';
    document.getElementById('chatTitle').textContent = t('liveChat');
    const area = document.getElementById('chatArea');
    // Restore previous live chat content if any
    if (liveChatHtml) {
      area.innerHTML = liveChatHtml;
      area.scrollTop = area.scrollHeight;
    } else {
      area.innerHTML = '';
    }
    updateUrl({ mode: 'live' });
    closeSidebar();
    // Only connect WS if not already connected
    if (!ws || ws.readyState !== WebSocket.OPEN) {
      connectWS();
    }
    document.getElementById('msgInput').focus();
  } else {
    btn.classList.remove('active');
    input.style.display = 'none';
    if (wsReconnectTimer) { clearTimeout(wsReconnectTimer); wsReconnectTimer = null; }
    // Save live chat content before leaving (keep WS alive)
    liveChatHtml = document.getElementById('chatArea').innerHTML;
    document.getElementById('chatArea').innerHTML = '<div class="empty">' + t('emptyHint') + '</div>';
    document.getElementById('chatTitle').textContent = t('selectSession');
    updateUrl(null);
  }
}

function connectWS() {
  if (wsReconnectTimer) { clearTimeout(wsReconnectTimer); wsReconnectTimer = null; }
  if (ws) { ws.onclose = null; ws.close(); }
  ws = new WebSocket(WS_URL);
  ws.onopen = () => {
    wsReconnectDelay = 1000;
    appendEvent(t('connected'), 'ev-thinking');
  };
  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.type === 'thinking') {
      appendEvent(t('thinking', {n: data.iteration}), 'ev-thinking');
    } else if (data.type === 'tool_call') {
      appendToolCall(data.name, data.arguments);
    } else if (data.type === 'tool_result') {
      appendToolResult(data.name, data.result);
    } else if (data.type === 'final') {
      appendBotMsg(data.content);
    } else if (data.type === 'error') {
      appendEvent(t('error') + data.message, 'ev-tool_result');
    }
    if (isLiveChat) {
      document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
    }
  };
  ws.onclose = () => {
    appendEvent(t('disconnected'), 'ev-thinking');
    if (isLiveChat) {
      wsReconnectTimer = setTimeout(() => {
        appendEvent(t('reconnecting'), 'ev-thinking');
        connectWS();
      }, wsReconnectDelay);
      wsReconnectDelay = Math.min(wsReconnectDelay * 2, 30000);
    }
  };
  ws.onerror = () => {};
}

function sendMsg() {
  const input = document.getElementById('msgInput');
  const msg = input.value.trim();
  if (!msg || !ws || ws.readyState !== WebSocket.OPEN) return;
  appendUserMsg(msg);
  ws.send(JSON.stringify({ message: msg, session: 'ws:console' }));
  input.value = '';
}

function appendUserMsg(text) {
  const html = `<div class="msg user"><div class="bubble">${escHtml(text)}</div><div class="time">${new Date().toLocaleTimeString(getLangLocale())}</div></div>`;
  if (isLiveChat) {
    const area = document.getElementById('chatArea');
    area.insertAdjacentHTML('beforeend', html);
  }
  // Always accumulate to liveChatHtml so content persists
  liveChatHtml += html;
}

function appendBotMsg(text) {
  const html = `<div class="msg assistant"><div class="bubble">${renderMd(text)}</div><div class="time">${new Date().toLocaleTimeString(getLangLocale())}</div></div>`;
  if (isLiveChat) {
    document.getElementById('chatArea').insertAdjacentHTML('beforeend', html);
  }
  liveChatHtml += html;
}

function appendEvent(text, cls) {
  const html = `<div class="stream-event ${cls}">${escHtml(text)}</div>`;
  if (isLiveChat) {
    document.getElementById('chatArea').insertAdjacentHTML('beforeend', html);
  }
  liveChatHtml += html;
}

// --- Tool Event Formatting ---
const TOOL_ICONS = {
  'viking_search': '\u{1f50d}', 'viking_find': '\u{1f50e}', 'viking_ls': '\u{1f4c2}',
  'viking_read': '\u{1f4d6}', 'viking_add': '\u{1f4e5}', 'viking_abstract': '\u{1f4cb}',
  'web_search': '\u{1f310}', 'search': '\u{1f50d}', 'find': '\u{1f50e}',
  'read': '\u{1f4c4}', 'write': '\u{270f}\u{fe0f}', 'run': '\u{26a1}', 'exec': '\u{26a1}',
  'python': '\u{1f40d}', 'calc': '\u{1f522}', 'weather': '\u{1f324}\u{fe0f}',
};

function getToolIcon(name) {
  if (!name) return '\u{2699}\u{fe0f}';
  const lower = name.toLowerCase();
  for (const [key, icon] of Object.entries(TOOL_ICONS)) {
    if (lower.includes(key)) return icon;
  }
  return '\u{2699}\u{fe0f}';
}

function formatToolArgs(argsStr) {
  if (!argsStr || argsStr === '{}') return '';
  try {
    const args = JSON.parse(argsStr);
    if (typeof args !== 'object' || args === null) return escHtml(argsStr);
    const entries = Object.entries(args);
    if (entries.length === 0) return '';
    return entries.map(([k, v]) => {
      let val = typeof v === 'string' ? v : JSON.stringify(v, null, 2);
      if (val.length > 200) val = val.substring(0, 200) + '...';
      return '<div class="arg-row"><span class="arg-key">' + escHtml(k) + ':</span><span class="arg-val">' + escHtml(val) + '</span></div>';
    }).join('');
  } catch(e) {
    const s = argsStr.length > 300 ? argsStr.substring(0, 300) + '...' : argsStr;
    return escHtml(s);
  }
}

function formatToolResult(result) {
  if (!result) return '<i>' + t('empty') + '</i>';
  const s = String(result);
  if (s.length <= 500) return escHtml(s);
  return escHtml(s.substring(0, 500)) + '\n<span style="opacity:0.5">... (' + s.length + ' ' + t('charsTotal') + ')</span>';
}

function getResultSummary(result) {
  if (!result) return '';
  const s = String(result);
  if (s.length <= 60) return s;
  const firstLine = s.split('\n')[0];
  if (firstLine.length <= 60) return firstLine;
  return firstLine.substring(0, 57) + '...';
}

let toolEventCounter = 0;

function buildToolCallHtml(name, argsStr) {
  const id = 'te_' + (++toolEventCounter);
  const icon = getToolIcon(name);
  const argsHtml = formatToolArgs(argsStr);
  const hasBody = argsHtml.length > 0;
  let argsSummary = '';
  try {
    const args = JSON.parse(argsStr || '{}');
    const keys = Object.keys(args);
    if (keys.length > 0) {
      const first = typeof args[keys[0]] === 'string' ? args[keys[0]] : JSON.stringify(args[keys[0]]);
      argsSummary = first.length > 40 ? first.substring(0, 37) + '...' : first;
    }
  } catch(e) {}
  const headerClick = hasBody ? ' onclick="toggleToolBody(\'' + id + '\')"' : '';
  const toggleHtml = hasBody ? '<span class="tool-toggle" id="' + id + '_toggle">\u{25b6}</span>' : '';
  const bodyHtml = hasBody ? '<div class="tool-event-body" id="' + id + '_body"><div class="tool-args-table">' + argsHtml + '</div></div>' : '';
  const summaryHtml = argsSummary ? '<span class="tool-result-summary">' + escHtml(argsSummary) + '</span>' : '';
  return '<div class="tool-event tool-call-event">'
    + '<div class="tool-event-header"' + headerClick + '>'
    + '<span class="tool-icon">' + icon + '</span>'
    + '<span class="tool-name">' + escHtml(name || 'unknown') + '</span>'
    + summaryHtml + toggleHtml
    + '</div>' + bodyHtml + '</div>';
}

function buildToolResultHtml(name, result) {
  const id = 'te_' + (++toolEventCounter);
  const resultStr = String(result || '');
  const isError = resultStr.toLowerCase().includes('error') || resultStr.includes('\u5931\u8d25');
  const summary = getResultSummary(resultStr);
  const hasBody = resultStr.length > 0;
  const errorClass = isError ? ' tool-error' : '';
  const headerClick = hasBody ? ' onclick="toggleToolBody(\'' + id + '\')"' : '';
  const toggleHtml = hasBody ? '<span class="tool-toggle" id="' + id + '_toggle">\u{25b6}</span>' : '';
  const bodyHtml = hasBody ? '<div class="tool-event-body" id="' + id + '_body">' + formatToolResult(resultStr) + '</div>' : '';
  const statusIcon = isError ? '\u{274c}' : '\u{2705}';
  return '<div class="tool-event tool-result-event' + errorClass + '">'
    + '<div class="tool-event-header"' + headerClick + '>'
    + '<span class="tool-icon">' + statusIcon + '</span>'
    + '<span class="tool-name">' + escHtml(name || 'result') + '</span>'
    + '<span class="tool-result-summary">' + escHtml(summary) + '</span>'
    + toggleHtml
    + '</div>' + bodyHtml + '</div>';
}

function appendToolCall(name, argsStr) {
  const html = buildToolCallHtml(name, argsStr);
  if (isLiveChat) {
    document.getElementById('chatArea').insertAdjacentHTML('beforeend', html);
  }
  liveChatHtml += html;
}

function appendToolResult(name, result) {
  const html = buildToolResultHtml(name, result);
  if (isLiveChat) {
    document.getElementById('chatArea').insertAdjacentHTML('beforeend', html);
  }
  liveChatHtml += html;
}

function toggleToolBody(id) {
  const body = document.getElementById(id + '_body');
  const toggle = document.getElementById(id + '_toggle');
  if (body && toggle) {
    body.classList.toggle('open');
    toggle.classList.toggle('open');
  }
}

// --- Settings Panel ---
let isSettingsMode = false;
let settingsData = null;

function openSettings() {
  const btn = document.getElementById('settingsBtn');
  const liveBtn = document.getElementById('liveChatBtn');
  const vikBtn = document.getElementById('vikingBtn');
  isSettingsMode = !isSettingsMode;
  if (isSettingsMode) {
    if (isLiveChat) { liveChatHtml = document.getElementById('chatArea').innerHTML; isLiveChat = false; liveBtn.classList.remove('active'); document.getElementById('inputArea').style.display = 'none'; }
    if (isVikingMode) { isVikingMode = false; vikBtn.classList.remove('active'); }
    currentSession = null;
    renderSessions();
    btn.classList.add('active');
    liveBtn.classList.remove('active');
    vikBtn.classList.remove('active');
    document.getElementById('inputArea').style.display = 'none';
    document.getElementById('chatTitle').textContent = t('settings');
    updateUrl({ mode: 'settings' });
    closeSidebar();
    loadSettings();
  } else {
    btn.classList.remove('active');
    document.getElementById('chatArea').innerHTML = '<div class="empty">' + t('emptyHint') + '</div>';
    document.getElementById('chatTitle').textContent = t('selectSession');
    updateUrl(null);
  }
}

async function loadSettings() {
  const area = document.getElementById('chatArea');
  area.innerHTML = '<div class="empty">' + t('loadingConfig') + '</div>';
  try {
    const r = await fetch(API + '/api/config');
    settingsData = await r.json();
    renderSettings();
  } catch(e) {
    area.innerHTML = '<div class="empty">' + t('failedLoadConfig') + escHtml(e.message) + '</div>';
  }
}

function renderSettings() {
  if (!settingsData) return;
  const d = settingsData;
  const area = document.getElementById('chatArea');

  // Tool params summary
  function paramSummary(params) {
    if (!params || !params.properties) return '';
    const req = params.required || [];
    return Object.keys(params.properties).map(k => req.includes(k) ? k : k + '?').join(', ');
  }

  const toolsHtml = (d.tools || []).map(t =>
    '<div class="tool-card">' +
    '<div class="tc-name">' + escHtml(t.name) + '</div>' +
    '<div class="tc-desc">' + escHtml(t.description) + '</div>' +
    '<div class="tc-params">params: ' + escHtml(paramSummary(t.parameters)) + '</div>' +
    '</div>'
  ).join('');

  const skillsHtml = (d.skills || []).map((s, i) =>
    '<div class="skill-card" onclick="showSkillDetail(' + i + ')">' +
    '<div class="sk-name">' + escHtml(s.name) + '</div>' +
    '<div class="sk-desc">' + escHtml(s.description) + '</div>' +
    '</div>'
  ).join('') || '<div style="color:var(--text-dim);font-size:13px">' + t('noSkills') + '</div>';

  const promptNames = Object.keys(d.prompt_files || {});
  const firstPrompt = promptNames[0] || '';
  const promptTabsHtml = promptNames.map((n, i) =>
    '<div class="prompt-tab' + (i === 0 ? ' active' : '') + '" onclick="switchPromptTab(\'' + escHtml(n) + '\', this)">' + escHtml(n) + '</div>'
  ).join('');
  const firstContent = d.prompt_files && d.prompt_files[firstPrompt] ? d.prompt_files[firstPrompt] : '';

  area.innerHTML =
    '<div class="settings-panel">' +

    '<div class="settings-section">' +
    '<h3>' + t('modelConfig') + '</h3>' +
    '<div class="settings-grid">' +
    '<label>' + t('model') + '</label><input id="cfgModel" value="' + escHtml(d.model || '') + '">' +
    '<label>' + t('provider') + '</label><input value="' + escHtml(d.provider || '') + '" disabled>' +
    '<label>' + t('temperature') + '</label><input id="cfgTemp" type="number" step="0.1" min="0" max="2" value="' + (d.temperature || 0.7) + '">' +
    '<label>' + t('maxTokens') + '</label><input id="cfgMaxTokens" type="number" step="1024" min="1024" value="' + (d.max_tokens || 8192) + '">' +
    '<label>' + t('maxIterations') + '</label><input id="cfgMaxIter" type="number" min="1" max="100" value="' + (d.max_tool_iterations || 50) + '">' +
    '</div>' +
    '<button class="settings-save" onclick="saveModelConfig()">' + t('saveConfig') + '</button>' +
    '<div class="settings-msg" id="cfgMsg"></div>' +
    '</div>' +

    '<div class="settings-section">' +
    '<h3>' + t('tools') + ' (' + (d.tools || []).length + ')</h3>' +
    toolsHtml +
    '</div>' +

    '<div class="settings-section">' +
    '<h3>' + t('skills') + ' (' + (d.skills || []).length + ')</h3>' +
    '<div id="skillsList">' + skillsHtml + '</div>' +
    '</div>' +

    '<div class="settings-section">' +
    '<h3>' + t('systemPrompts') + '</h3>' +
    '<div class="prompt-tabs" id="promptTabs">' + promptTabsHtml + '</div>' +
    '<textarea class="prompt-editor" id="promptEditor" data-file="' + escHtml(firstPrompt) + '">' + escHtml(firstContent) + '</textarea>' +
    '<button class="settings-save" onclick="savePromptFile()">' + t('savePrompt') + '</button>' +
    '<div class="settings-msg" id="promptMsg"></div>' +
    '</div>' +

    (d.memory ? '<div class="settings-section"><h3>' + t('memory') + '</h3><pre style="font-size:12px;line-height:1.6;white-space:pre-wrap;max-height:300px;overflow-y:auto;background:var(--pre-bg);padding:10px;border-radius:6px">' + escHtml(d.memory) + '</pre></div>' : '') +

    '</div>';
}

function showSkillDetail(idx) {
  if (!settingsData || !settingsData.skills || !settingsData.skills[idx]) return;
  const skill = settingsData.skills[idx];
  const area = document.getElementById('skillsList');
  if (!area) return;
  // Toggle: if already showing detail, go back to list
  if (area.querySelector('.skill-detail')) {
    renderSettings();
    return;
  }
  area.innerHTML =
    '<button class="viking-back-btn" onclick="renderSettings()">' + t('back') + '</button>' +
    '<div class="skill-detail">' + renderMd(skill.content || skill.description) + '</div>';
}

function switchPromptTab(filename, el) {
  if (!settingsData || !settingsData.prompt_files) return;
  document.querySelectorAll('.prompt-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  const editor = document.getElementById('promptEditor');
  if (editor) {
    editor.value = settingsData.prompt_files[filename] || '';
    editor.dataset.file = filename;
  }
  const msg = document.getElementById('promptMsg');
  if (msg) msg.textContent = '';
}

async function saveModelConfig() {
  const btn = document.querySelector('.settings-save');
  const msg = document.getElementById('cfgMsg');
  const body = {};
  const model = document.getElementById('cfgModel').value.trim();
  const temp = parseFloat(document.getElementById('cfgTemp').value);
  const maxTokens = parseInt(document.getElementById('cfgMaxTokens').value);
  const maxIter = parseInt(document.getElementById('cfgMaxIter').value);
  if (model && model !== settingsData.model) body.model = model;
  if (!isNaN(temp) && temp !== settingsData.temperature) body.temperature = temp;
  if (!isNaN(maxTokens) && maxTokens !== settingsData.max_tokens) body.max_tokens = maxTokens;
  if (!isNaN(maxIter) && maxIter !== settingsData.max_tool_iterations) body.max_tool_iterations = maxIter;
  if (Object.keys(body).length === 0) { msg.textContent = t('noChanges'); msg.className = 'settings-msg'; return; }
  try {
    btn.disabled = true;
    const r = await fetch(API + '/api/config', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
    const result = await r.json();
    if (result.status === 'updated') {
      msg.textContent = t('saved') + result.changed.join(', ') + '. ' + t('restartToApply');
      msg.className = 'settings-msg ok';
    } else {
      msg.textContent = result.detail || t('noChanges');
      msg.className = 'settings-msg';
    }
  } catch(e) {
    msg.textContent = t('error') + e.message;
    msg.className = 'settings-msg err';
  } finally { btn.disabled = false; }
}

async function savePromptFile() {
  const editor = document.getElementById('promptEditor');
  const msg = document.getElementById('promptMsg');
  if (!editor) return;
  const filename = editor.dataset.file;
  const content = editor.value;
  try {
    const r = await fetch(API + '/api/config/prompt', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ filename, content })
    });
    const result = await r.json();
    if (result.status === 'updated') {
      msg.textContent = t('saved') + filename + ' (' + result.size + ' bytes)';
      msg.className = 'settings-msg ok';
      if (settingsData && settingsData.prompt_files) settingsData.prompt_files[filename] = content;
    } else {
      msg.textContent = result.detail || t('error');
      msg.className = 'settings-msg err';
    }
  } catch(e) {
    msg.textContent = t('error') + e.message;
    msg.className = 'settings-msg err';
  }
}

// --- Viking Knowledge Base ---
let isVikingMode = false;
let vikingCurrentUri = 'viking://resources/';

function openViking() {
  const btn = document.getElementById('vikingBtn');
  const liveBtn = document.getElementById('liveChatBtn');
  isVikingMode = !isVikingMode;
  if (isVikingMode) {
    // Save live chat content if leaving live mode
    if (isLiveChat) {
      liveChatHtml = document.getElementById('chatArea').innerHTML;
      isLiveChat = false;
      document.getElementById('liveChatBtn').classList.remove('active');
      document.getElementById('inputArea').style.display = 'none';
    }
    currentSession = null;
    renderSessions();
    btn.classList.add('active');
    liveBtn.classList.remove('active');
    document.getElementById('inputArea').style.display = 'none';
    document.getElementById('chatTitle').textContent = t('knowledge');
    updateUrl({ mode: 'viking' });
    closeSidebar();
    renderVikingBrowser();
  } else {
    btn.classList.remove('active');
    document.getElementById('chatArea').innerHTML = '<div class="empty">' + t('emptyHint') + '</div>';
    document.getElementById('chatTitle').textContent = t('selectSession');
    updateUrl(null);
  }
}

function renderVikingBrowser() {
  const area = document.getElementById('chatArea');
  area.innerHTML = `
    <div class="viking-panel">
      <div class="viking-search">
        <input type="text" id="vikingSearchInput" placeholder="${t('searchKB')}" onkeydown="if(event.key==='Enter'&&!event.isComposing&&event.keyCode!==229)vikingSearch()">
        <button onclick="vikingSearch()">${t('search')}</button>
      </div>
      <div class="viking-breadcrumb" id="vikingBreadcrumb"></div>
      <div class="viking-content" id="vikingContent">
        <div class="viking-empty">${t('loading')}</div>
      </div>
    </div>`;
  vikingLs(vikingCurrentUri);
}

function buildBreadcrumb(uri) {
  const bc = document.getElementById('vikingBreadcrumb');
  if (!bc) return;
  // Parse uri like viking://resources/foo/bar/
  const parts = uri.replace('viking://', '').split('/').filter(Boolean);
  let html = '<a onclick="vikingLs(\'viking://resources/\')">' + t('resources') + '</a>';
  let path = 'viking://resources/';
  for (let i = 1; i < parts.length; i++) {
    path += parts[i] + '/';
    const p = path; // capture
    html += ` / <a onclick="vikingLs('${p}')">${parts[i]}</a>`;
  }
  bc.innerHTML = html;
}

async function vikingLs(uri) {
  vikingCurrentUri = uri;
  buildBreadcrumb(uri);
  const content = document.getElementById('vikingContent');
  if (!content) return;
  content.innerHTML = '<div class="viking-empty">' + t('loading') + '</div>';
  try {
    const r = await fetch(`${API}/api/viking/ls?uri=${encodeURIComponent(uri)}`);
    const d = await r.json();
    const result = d.result || '';
    if (result.includes('disabled') || result.includes('not initialized')) {
      content.innerHTML = '<div class="viking-empty">' + t('vikingUnavailable') + '</div>';
      return;
    }
    // Parse the text result from viking_service.ls()
    const lines = result.split('\n').slice(1); // skip header
    if (lines.length === 0 || result.includes('empty')) {
      content.innerHTML = '<div class="viking-empty">' + t('emptyDir') + '</div>';
      return;
    }
    content.innerHTML = lines.map(line => {
      const m = line.match(/^\s*(ðŸ“|ðŸ“„)\s*(.+?)\s*\((\d+)b\)\s*$/);
      if (!m) return '';
      const [, icon, name, size] = m;
      const isDir = icon === 'ðŸ“';
      const itemUri = uri.endsWith('/') ? uri + name : uri + '/' + name;
      if (name.startsWith('.')) return ''; // hide hidden files
      const onclick = isDir
        ? `vikingLs('${itemUri}/')`
        : `vikingReadResource('${itemUri}')`;
      return `<div class="viking-item" onclick="${onclick}">
        <span class="vi-icon">${icon}</span>
        <span class="vi-name">${escHtml(name)}</span>
        <div class="vi-meta">${isDir ? t('directory') : formatSize(parseInt(size))}</div>
      </div>`;
    }).filter(Boolean).join('') || '<div class="viking-empty">' + t('noItems') + '</div>';
  } catch(e) {
    content.innerHTML = '<div class="viking-empty">' + t('error') + escHtml(e.message) + '</div>';
  }
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/1048576).toFixed(1) + ' MB';
}

async function vikingReadResource(uri) {
  const content = document.getElementById('vikingContent');
  if (!content) return;
  content.innerHTML = '<div class="viking-empty">' + t('loading') + '</div>';
  try {
    // Try to get abstract first, then full read
    const [absR, readR] = await Promise.allSettled([
      fetch(`${API}/api/viking/search`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({query: uri.split('/').pop(), limit: 1})
      }),
      // We don't have a direct read endpoint via HTTP, so show the abstract
      fetch(`${API}/api/viking/ls?uri=${encodeURIComponent(uri)}`)
    ]);
    // Show resource detail view
    const name = uri.split('/').filter(Boolean).pop();
    content.innerHTML = `
      <div class="viking-detail">
        <button class="viking-back-btn" onclick="vikingLs('${vikingCurrentUri.replace(/[^/]+\/?$/, '')}')">${t('back')}</button>
        <h3>${escHtml(name)}</h3>
        <div class="vd-meta">URI: ${escHtml(uri)}</div>
        <div class="vd-body">${escHtml(name)} - Resource details loaded from Viking.</div>
      </div>`;
  } catch(e) {
    content.innerHTML = '<div class="viking-empty">' + t('error') + escHtml(e.message) + '</div>';
  }
}

async function vikingSearch() {
  const input = document.getElementById('vikingSearchInput');
  if (!input) return;
  const query = input.value.trim();
  if (!query) return;
  const content = document.getElementById('vikingContent');
  if (!content) return;
  content.innerHTML = '<div class="viking-empty">' + t('searching') + '</div>';
  const bc = document.getElementById('vikingBreadcrumb');
  if (bc) bc.innerHTML = `Search: "${escHtml(query)}"`;
  try {
    const r = await fetch(`${API}/api/viking/search`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({query: query, limit: 10})
    });
    const d = await r.json();
    const result = d.result || '';
    if (result.includes('no result') || result.includes('æ— ç»“æžœ')) {
      content.innerHTML = '<div class="viking-empty">' + t('noResults', {query}) + '</div>';
      return;
    }
    // Parse search results
    const blocks = result.split('\n\n').slice(1); // skip header
    if (blocks.length === 0) {
      content.innerHTML = '<div class="viking-empty">' + t('noResultsGeneric') + '</div>';
      return;
    }
    content.innerHTML = blocks.map(block => {
      const isMemory = block.startsWith('[memory]') || block.startsWith('[è®°å¿†]');
      const isResource = block.startsWith('[resource') || block.startsWith('[èµ„æº');
      const typeClass = isMemory ? 'vr-memory' : 'vr-resource';
      const typeLabel = isMemory ? 'Memory' : 'Resource';
      return `<div class="viking-result">
        <span class="vr-type ${typeClass}">${typeLabel}</span>
        <div class="vr-content">${renderMd(block)}</div>
      </div>`;
    }).join('');
  } catch(e) {
    content.innerHTML = '<div class="viking-empty">' + t('error') + escHtml(e.message) + '</div>';
  }
}

// --- Browser history navigation ---
window.addEventListener('popstate', () => {
  const params = new URLSearchParams(location.search);
  const sessionId = params.get('session') || params.get('s');
  const mode = params.get('mode');
  if (sessionId) {
    loadChat(sessionId);
  } else if (mode === 'live') {
    if (!isLiveChat) openLiveChat();
  } else if (mode === 'viking') {
    if (!isVikingMode) openViking();
  } else if (mode === 'settings') {
    if (!isSettingsMode) openSettings();
  }
});

// --- Sidebar (mobile) ---
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('open');
}

// --- Init ---
initTheme();
initLang();
checkHealth();
loadSessions().then(() => {
  // URL routing: navigate to session/mode from URL params
  const params = new URLSearchParams(location.search);
  const sessionId = params.get('session') || params.get('s');
  const mode = params.get('mode');
  if (sessionId) {
    // Find matching session (exact match or partial match)
    const exact = sessions.find(s => s.name === sessionId);
    const partial = !exact && sessions.find(s => s.name.includes(sessionId));
    const target = exact || partial;
    if (target) {
      loadChat(target.name);
    } else {
      // Try loading directly even if not in session list
      loadChat(sessionId);
    }
  } else if (mode === 'live') {
    openLiveChat();
  } else if (mode === 'viking') {
    openViking();
  } else if (mode === 'settings') {
    openSettings();
  }
});
setInterval(checkHealth, 30000);
</script>
</body>
</html>
